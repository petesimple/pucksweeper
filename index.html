<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PuckSweeper</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b3ea8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <link rel="icon" href="icon-512.png" sizes="512x512" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#07142d;
      --table:#0b3ea8;
      --table2:#0a3796;
      --rail:#bfc5ce;
      --rail2:#9aa2ad;
      --text:#eaf2ff;
      --muted:#c8d3ea;

      --puck-yellow:#ffd400;
      --puck-red:#ff2a2a;
      --puck-green:#39ff14;

      --tile:#1d4fb9;
      --tile2:#1946a3;

      --shadow: rgba(0,0,0,.35);
      --px: 2px;

      --gap: 6px;
      --gridPad: 10px;
      --tileSize: 30px; /* JS will override */
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:
        radial-gradient(circle at 20% 15%, rgba(255,255,255,.10), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,.08), rgba(255,255,255,0) 45%),
        linear-gradient(180deg, var(--bg), #050b16);
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      gap:12px;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }

    .logo{
      height: 56px;
      width: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.35));
    }

    .title .tag{
      font-size:12px;
      color: var(--muted);
      opacity:.95;
      line-height: 1.1;
    }

    @media (max-width: 520px){
      .logo{ height: 40px; }
    }

    .panel{
      background: rgba(255,255,255,.06);
      border: var(--px) solid rgba(255,255,255,.12);
      box-shadow: 0 10px 25px var(--shadow);
      border-radius: 12px;
      padding:12px;
    }

    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .hud-left, .hud-right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .meter{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,.20);
      border: var(--px) solid rgba(255,255,255,.10);
      min-width: 150px;
    }
    .meter .label{
      font-size:11px;
      color: var(--muted);
    }
    .meter .value{
      font-size:16px;
      letter-spacing:1px;
    }

    button, select{
      appearance:none;
      border:none;
      font: inherit;
      color: var(--text);
      background: rgba(0,0,0,.22);
      border: var(--px) solid rgba(255,255,255,.16);
      border-radius: 10px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .06s ease, filter .12s ease;
      touch-action: manipulation;
    }
    button:active{ transform: translateY(1px); }
    select{ padding-right: 34px; }

    .btn{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      letter-spacing:1px;
      white-space: nowrap;
    }
    .btn small{
      font-weight:400;
      letter-spacing:0;
      opacity:.85;
    }

    .btn.flag-on{
      filter: brightness(1.2);
      box-shadow: inset 0 0 0 999px rgba(255,255,255,.06);
    }

    .table{
      position:relative;
      background:
        repeating-linear-gradient(45deg, rgba(255,255,255,.05) 0 6px, rgba(255,255,255,0) 6px 12px),
        linear-gradient(180deg, var(--table), var(--table2));
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 18px 50px var(--shadow);
      border: var(--px) solid rgba(255,255,255,.14);
    }

    .rails{
      background: linear-gradient(180deg, var(--rail), var(--rail2));
      border-radius: 14px;
      padding: 12px;
      border: var(--px) solid rgba(0,0,0,.20);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.25);
    }

    .grid{
      display:grid;
      gap: var(--gap);
      user-select:none;
      touch-action: manipulation;
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      padding: var(--gridPad);
      border: var(--px) solid rgba(0,0,0,.18);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.10);
      justify-content:center;
      max-width: 100%;
      overflow: hidden;
    }

    .tile{
      width: var(--tileSize);
      height: var(--tileSize);
      border-radius: 999px;
      display:grid;
      place-items:center;
      position:relative;
      padding:0;

      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), rgba(255,255,255,0) 45%),
                linear-gradient(180deg, var(--tile), var(--tile2));
      border: var(--px) solid rgba(0,0,0,.22);
      box-shadow: 0 2px 0 rgba(0,0,0,.25);
      cursor:pointer;
    }

    .tile.revealed{
      cursor: default;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
                linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.06));
      border-color: rgba(0,0,0,.20);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.14);
    }

    .tile.flagged::after{
      content:"F";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:900;
      font-size: calc(var(--tileSize) * 0.55);
      color:#ffef7a;
      text-shadow: 0 2px 0 rgba(0,0,0,.35);
    }

    .puck{
      width: calc(var(--tileSize) * 0.74);
      height: calc(var(--tileSize) * 0.74);
      border-radius: 999px;
      border: var(--px) solid rgba(0,0,0,.25);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      font-size: calc(var(--tileSize) * 0.48);
      font-weight: 900;
      line-height:1;
      color: rgba(0,0,0,.70);
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }

    .puck.yellow{ background: var(--puck-yellow); }
    .puck.red{
      background: var(--puck-red);
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 0 rgba(0,0,0,.35);
    }
    .puck.green{ background: var(--puck-green); }

    .mallet{
      width: calc(var(--tileSize) * 0.74);
      height: calc(var(--tileSize) * 0.74);
      position:relative;
      border-radius: 6px;
      background: #2b2f36;
      border: var(--px) solid rgba(0,0,0,.35);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.10);
    }
    .mallet::before{
      content:"";
      position:absolute;
      width: calc(var(--tileSize) * 0.20);
      height: calc(var(--tileSize) * 0.55);
      left: calc(50% - (var(--tileSize) * 0.10));
      top: calc(var(--tileSize) * -0.40);
      border-radius: 3px;
      background: #c18a3a;
      border: var(--px) solid rgba(0,0,0,.25);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.12);
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color: var(--muted);
      margin-top:10px;
    }
    .legend .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.20);
      border: var(--px) solid rgba(255,255,255,.12);
      white-space:nowrap;
    }
    .dot{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: var(--px) solid rgba(0,0,0,.25);
    }
    .dot.yellow{ background: var(--puck-yellow); }
    .dot.red{ background: var(--puck-red); }
    .dot.green{ background: var(--puck-green); }

    .msg{
      font-size: 13px;
      color: var(--text);
      opacity:.95;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.65);
      border: var(--px) solid rgba(255,255,255,.16);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      font-size: 12px;
      color: var(--text);
      max-width: min(640px, calc(100% - 24px));
      display:none;
      z-index: 40;
    }
    .toast.show{ display:block; }

    @media (max-width: 520px){
      .meter{ min-width: 140px; }
    }

    /* Share modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.show{ display:flex; }

    .modal-card{
      width: min(560px, 100%);
      background: rgba(10,16,30,.95);
      border: var(--px) solid rgba(255,255,255,.14);
      border-radius: 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 14px;
      text-align:center;
      max-height: calc(100vh - 36px);
      overflow:auto;
    }
    .modal-card h2{
      margin: 4px 0 10px;
      font-size: 16px;
      letter-spacing:1px;
    }
    .qr-wrap{
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      display:inline-block;
      border: var(--px) solid rgba(0,0,0,.18);
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
    }
    .qr{
      width: min(320px, 70vw);
      height: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      display:block;
    }
    .share-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      margin-top: 12px;
    }
    .share-url{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
      opacity:.95;
    }

    /* HowTo content */
    .howto{
      text-align:left;
      background: rgba(255,255,255,.04);
      border: var(--px) solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 12px;
    }
    .howto h3{
      margin: 10px 0 6px;
      font-size: 13px;
      letter-spacing: 1px;
      color: var(--text);
    }
    .howto p, .howto li{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .howto ul{
      margin: 6px 0 10px 18px;
      padding: 0;
    }
    .kbd{
      display:inline-block;
      padding: 1px 6px;
      border-radius: 6px;
      background: rgba(0,0,0,.25);
      border: var(--px) solid rgba(255,255,255,.10);
      color: var(--text);
      font-size: 11px;
      letter-spacing: .5px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <img class="logo" src="logo.png" alt="PuckSweeper" />
        <div class="tag">8bit air hockey minesweeper</div>
      </div>
      <div class="msg" id="statusMsg">Tap to clear. Use FLAG for mallets. Double tap a revealed puck to chord.</div>
    </div>

    <div class="panel">
      <div class="hud">
        <div class="hud-left">
          <div class="meter" title="Mallets remaining (flags) - like classic minesweeper">
            <div>
              <div class="label">MALLETS LEFT</div>
              <div class="value" id="malletsLeft">000</div>
            </div>
          </div>
          <div class="meter" title="Time">
            <div>
              <div class="label">TIME</div>
              <div class="value" id="timeVal">000</div>
            </div>
          </div>
        </div>

        <div class="hud-right">
          <select id="difficulty" title="Difficulty">
            <option value="beginner">Bar Table (9x9, 10 mallets)</option>
            <option value="intermediate">Tournament Table (16x16, 40 mallets)</option>
            <option value="expert">Worlds Table (30x16, 99 mallets)</option>
          </select>

          <button class="btn" id="howtoBtn" title="How to play">
            HOWTO
            <small>PLAY</small>
          </button>

          <button class="btn" id="shareBtn" title="Share (QR code)">
            SHARE
            <small>QR</small>
          </button>

          <button class="btn" id="flagBtn" title="Toggle flag mode">
            FLAG
            <small id="flagState">OFF</small>
          </button>

          <button class="btn" id="newBtn" title="New game">
            NEW
            <small id="face">:)</small>
          </button>
        </div>
      </div>

      <div class="legend">
        <div class="chips">
          <div class="chip"><span class="dot yellow"></span>Yellow puck = 1 to 2</div>
          <div class="chip"><span class="dot red"></span>Red puck = 3 to 4</div>
          <div class="chip"><span class="dot green"></span>Neon green puck = 5 to 8</div>
        </div>
        <div class="chips">
          <div class="chip">Desktop: right click flags</div>
          <div class="chip">Mobile: FLAG mode or long press flags</div>
        </div>
      </div>
    </div>

    <div class="table">
      <div class="rails">
        <div class="grid" id="grid" aria-label="PuckSweeper grid"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Share modal -->
  <div class="modal" id="shareModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Share PuckSweeper">
      <h2>SCAN TO PLAY</h2>
      <div class="qr-wrap">
        <img class="qr" src="pucksweeper_qr.png" alt="QR code to PuckSweeper" />
      </div>

      <div class="share-row">
        <button class="btn" id="nativeShareBtn" title="Native share (if supported)">SHARE LINK</button>
        <button class="btn" id="copyLinkBtn" title="Copy link">COPY</button>
        <button class="btn" id="closeShareBtn" title="Close">CLOSE</button>
      </div>

      <div class="share-url" id="shareUrlText">https://petesimple.github.io/pucksweeper/</div>
    </div>
  </div>

  <!-- Howto modal -->
  <div class="modal" id="howtoModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="How to play PuckSweeper">
      <h2>HOW TO PLAY</h2>

      <div class="howto">
        <h3>Goal</h3>
        <p>Clear every tile that is not a mallet. Numbers tell you how many mallets touch that tile (8 directions).</p>

        <h3>Controls</h3>
        <ul>
          <li><strong>Tap</strong> a tile to clear it.</li>
          <li><strong>FLAG</strong> mode: tap to mark suspected mallets.</li>
          <li><strong>Mobile</strong>: long press a tile to flag it.</li>
          <li><strong>Desktop</strong>: right click a tile to flag it.</li>
          <li><strong>Chord</strong>: double click or double tap a revealed numbered tile to clear its neighbors
            <em>only when</em> the number of flags around it matches the number.</li>
        </ul>

        <h3>Reading the pucks</h3>
        <ul>
          <li><span class="kbd">Yellow</span> numbers are 1 to 2</li>
          <li><span class="kbd">Red</span> numbers are 3 to 4</li>
          <li><span class="kbd">Neon</span> numbers are 5 to 8</li>
        </ul>

        <h3>Strategy</h3>
        <ul>
          <li><strong>Start from edges</strong>: corners and borders have fewer neighbors, so the math is cleaner.</li>
          <li><strong>Flag with purpose</strong>: only flag when you are sure. Too many flags slows you down and breaks chording.</li>
          <li><strong>Use “one left” patterns</strong>: if a 1 touches only one hidden tile, that tile is a mallet. Same idea for any number.</li>
          <li><strong>Think in overlaps</strong>: compare two nearby numbers. If one’s hidden neighbors are a subset of the other, you can deduce safe tiles.</li>
          <li><strong>Chord to go fast</strong>: once you are confident, chording clears big areas safely and saves time.</li>
          <li><strong>When guessing is unavoidable</strong>: pick the tile with the most information around it, not a random one in the dark.</li>
        </ul>

        <h3>Pro tip</h3>
        <p>If you hit a mallet, it’s not your fault. The table was clearly tilted. Play puck.</p>
      </div>

      <div class="share-row">
        <button class="btn" id="closeHowtoBtn" title="Close">CLOSE</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const gridEl = document.getElementById("grid");
    const malletsLeftEl = document.getElementById("malletsLeft");
    const timeEl = document.getElementById("timeVal");
    const difficultyEl = document.getElementById("difficulty");
    const newBtn = document.getElementById("newBtn");
    const faceEl = document.getElementById("face");
    const statusMsg = document.getElementById("statusMsg");
    const toastEl = document.getElementById("toast");

    const flagBtn = document.getElementById("flagBtn");
    const flagState = document.getElementById("flagState");

    // Share UI
    const shareBtn = document.getElementById("shareBtn");
    const shareModal = document.getElementById("shareModal");
    const closeShareBtn = document.getElementById("closeShareBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const nativeShareBtn = document.getElementById("nativeShareBtn");
    const shareUrlText = document.getElementById("shareUrlText");

    // Howto UI
    const howtoBtn = document.getElementById("howtoBtn");
    const howtoModal = document.getElementById("howtoModal");
    const closeHowtoBtn = document.getElementById("closeHowtoBtn");

    const SHARE_URL = "https://petesimple.github.io/pucksweeper/";
    shareUrlText.textContent = SHARE_URL;

    const DIFFS = {
      beginner: { w: 9, h: 9, m: 10 },
      intermediate: { w: 16, h: 16, m: 40 },
      expert: { w: 30, h: 16, m: 99 }
    };

    let W = 9, H = 9, MALLETS = 10;
    let cells = [];
    let started = false;
    let gameOver = false;
    let flags = 0;
    let revealedCount = 0;
    let timer = null;
    let t = 0;
    let flagMode = false;

    function pad3(n){
      n = Math.max(0, n|0);
      return String(n).padStart(3, "0");
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.classList.remove("show"), 1500);
    }

    function openModal(modal){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(modal){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    function isOpen(modal){
      return modal.classList.contains("show");
    }

    function idx(x,y){ return y*W + x; }
    function inb(x,y){ return x>=0 && y>=0 && x<W && y<H; }

    function neighbors(x,y){
      const out = [];
      for(let dy=-1; dy<=1; dy++){
        for(let dx=-1; dx<=1; dx++){
          if(dx===0 && dy===0) continue;
          const nx = x+dx, ny = y+dy;
          if(inb(nx,ny)) out.push(idx(nx,ny));
        }
      }
      return out;
    }

    function resetTimer(){
      if(timer) clearInterval(timer);
      timer = null;
      t = 0;
      timeEl.textContent = pad3(t);
    }

    function startTimer(){
      if(timer) return;
      timer = setInterval(() => {
        t++;
        timeEl.textContent = pad3(t);
      }, 1000);
    }

    function setFace(sym){
      faceEl.textContent = sym;
    }

    function updateMalletsLeft(){
      const left = MALLETS - flags;
      malletsLeftEl.textContent = pad3(left);
    }

    function setStatus(msg){
      statusMsg.textContent = msg;
    }

    function buildEmpty(){
      cells = new Array(W*H).fill(0).map((_, i) => ({
        i,
        x: i % W,
        y: Math.floor(i / W),
        mallet: false,
        n: 0,
        revealed: false,
        flagged: false,
        el: null
      }));
    }

    function placeMalletsAvoiding(firstIndex){
      const forbidden = new Set([firstIndex, ...neighbors(cells[firstIndex].x, cells[firstIndex].y)]);
      let placed = 0;

      const candidates = [];
      for(let i=0;i<cells.length;i++){
        if(!forbidden.has(i)) candidates.push(i);
      }

      for(let i=candidates.length-1;i>0;i--){
        const j = (Math.random() * (i+1))|0;
        [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
      }

      for(const i of candidates){
        if(placed >= MALLETS) break;
        cells[i].mallet = true;
        placed++;
      }

      while(placed < MALLETS){
        const i = (Math.random() * cells.length)|0;
        if(forbidden.has(i)) continue;
        if(cells[i].mallet) continue;
        cells[i].mallet = true;
        placed++;
      }
    }

    function computeNumbers(){
      for(const c of cells){
        if(c.mallet){ c.n = -1; continue; }
        const ns = neighbors(c.x, c.y);
        let count = 0;
        for(const ni of ns) if(cells[ni].mallet) count++;
        c.n = count;
      }
    }

    function puckClassFor(n){
      if(n <= 0) return null;
      if(n <= 2) return "yellow";
      if(n <= 4) return "red";
      return "green";
    }

    function computeTileSize(){
      const rails = document.querySelector(".rails");
      const rect = rails.getBoundingClientRect();

      const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--gap")) || 6;
      const gridPad = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--gridPad")) || 10;

      const availableW = Math.max(240, rect.width - gridPad*2);
      const availableH = Math.max(240, window.innerHeight - 340);

      const sizeByW = Math.floor((availableW - gap*(W-1)) / W);
      const sizeByH = Math.floor((availableH - gap*(H-1)) / H);

      const size = Math.max(18, Math.min(42, Math.min(sizeByW, sizeByH)));

      document.documentElement.style.setProperty("--tileSize", size + "px");
      gridEl.style.gridTemplateColumns = `repeat(${W}, var(--tileSize))`;
      gridEl.style.gridTemplateRows = `repeat(${H}, var(--tileSize))`;
    }

    function render(){
      gridEl.innerHTML = "";
      computeTileSize();

      for(const c of cells){
        const b = document.createElement("button");
        b.className = "tile";
        b.type = "button";
        b.dataset.i = c.i;

        b.addEventListener("pointerdown", (e) => {
          if(gameOver) return;
          b.setPointerCapture?.(e.pointerId);
          b._downAt = Date.now();
          b._downX = e.clientX;
          b._downY = e.clientY;
        });

        b.addEventListener("pointerup", (e) => {
          if(gameOver) return;

          const held = Date.now() - (b._downAt || Date.now());
          const moved = Math.hypot(
            (e.clientX - (b._downX||e.clientX)),
            (e.clientY - (b._downY||e.clientY))
          );
          const isLongPress = (held > 420 && moved < 10);

          if(e.pointerType === "mouse" && e.button === 2){
            e.preventDefault();
            onFlag(c.i);
            return;
          }

          if(isLongPress){
            onFlag(c.i);
            return;
          }

          if(flagMode){
            onFlag(c.i);
          }else{
            onReveal(c.i);
          }
        });

        b.addEventListener("contextmenu", (e) => e.preventDefault());

        b.addEventListener("dblclick", (e) => {
          e.preventDefault();
          onChord(c.i);
        });

        c.el = b;
        gridEl.appendChild(b);
        paintCell(c);
      }
    }

    function paintCell(c){
      const el = c.el;
      if(!el) return;

      el.classList.toggle("revealed", c.revealed);
      el.classList.toggle("flagged", c.flagged);

      if(!c.revealed){
        el.innerHTML = "";
        return;
      }

      if(c.mallet){
        el.innerHTML = `<div class="mallet" aria-hidden="true"></div>`;
        return;
      }

      if(c.n === 0){
        el.innerHTML = "";
        return;
      }

      const cls = puckClassFor(c.n);
      el.innerHTML = `<div class="puck ${cls}" aria-hidden="true">${c.n}</div>`;
    }

    function revealAllMallets(){
      for(const c of cells){
        if(c.mallet){
          c.revealed = true;
          paintCell(c);
        }
      }
    }

    function endGame(win){
      gameOver = true;
      if(timer) clearInterval(timer);
      timer = null;

      if(win){
        setFace("B)");
        setStatus(`Clean sweep - you found all the mallets in ${t}s`);
        toast("PLAY PUCK - you win");
      }else{
        setFace("X(");
        setStatus("Clack - you hit a mallet");
        toast("Malleted");
        revealAllMallets();
      }
    }

    function tryWin(){
      const safeTotal = W*H - MALLETS;
      if(revealedCount >= safeTotal){
        for(const c of cells){
          if(c.mallet && !c.flagged){
            c.flagged = true;
            flags++;
            paintCell(c);
          }
        }
        updateMalletsLeft();
        endGame(true);
      }
    }

    function onFirstAction(i){
      if(started) return;
      started = true;
      placeMalletsAvoiding(i);
      computeNumbers();
      startTimer();
    }

    function onReveal(i){
      if(gameOver) return;
      const c = cells[i];
      if(c.revealed || c.flagged) return;

      onFirstAction(i);

      if(c.mallet){
        c.revealed = true;
        paintCell(c);
        endGame(false);
        return;
      }

      floodReveal(i);
      tryWin();
    }

    function floodReveal(i){
      const stack = [i];
      while(stack.length){
        const ci = stack.pop();
        const c = cells[ci];
        if(c.revealed || c.flagged) continue;
        c.revealed = true;
        revealedCount++;
        paintCell(c);

        if(c.n === 0){
          const ns = neighbors(c.x, c.y);
          for(const ni of ns){
            const ncell = cells[ni];
            if(!ncell.revealed && !ncell.flagged && !ncell.mallet){
              stack.push(ni);
            }
          }
        }
      }
    }

    function onFlag(i){
      if(gameOver) return;
      const c = cells[i];
      if(c.revealed) return;

      if(!started){
        started = true;
        placeMalletsAvoiding(i);
        computeNumbers();
        startTimer();
      }

      c.flagged = !c.flagged;
      flags += c.flagged ? 1 : -1;
      paintCell(c);
      updateMalletsLeft();
      tryWin();
    }

    function onChord(i){
      if(gameOver) return;
      const c = cells[i];
      if(!c.revealed) return;
      if(c.n <= 0) return;

      const ns = neighbors(c.x, c.y);
      let flaggedAround = 0;
      for(const ni of ns) if(cells[ni].flagged) flaggedAround++;

      if(flaggedAround !== c.n) return;

      for(const ni of ns){
        const ncell = cells[ni];
        if(ncell.flagged || ncell.revealed) continue;

        if(ncell.mallet){
          ncell.revealed = true;
          paintCell(ncell);
          endGame(false);
          return;
        }
        floodReveal(ni);
      }
      tryWin();
    }

    function setFlagMode(on){
      flagMode = !!on;
      flagBtn.classList.toggle("flag-on", flagMode);
      flagState.textContent = flagMode ? "ON" : "OFF";
      setStatus(flagMode
        ? "FLAG mode: tap pucks to mark mallets. Tap FLAG to go back."
        : "Tap to clear. Use FLAG for mallets. Double tap a revealed puck to chord."
      );
      toast(flagMode ? "Flag mode ON" : "Flag mode OFF");
    }

    function newGame(){
      const diff = DIFFS[difficultyEl.value] || DIFFS.beginner;
      W = diff.w; H = diff.h; MALLETS = diff.m;

      started = false;
      gameOver = false;
      flags = 0;
      revealedCount = 0;

      resetTimer();
      setFace(":)");
      setFlagMode(false);

      buildEmpty();
      updateMalletsLeft();
      render();
      toast("New table ready");
    }

    // Share modal events
    shareBtn.addEventListener("click", () => openModal(shareModal));
    closeShareBtn.addEventListener("click", () => closeModal(shareModal));
    shareModal.addEventListener("click", (e) => {
      if(e.target === shareModal) closeModal(shareModal);
    });

    copyLinkBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(SHARE_URL);
        toast("Copied link");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = SHARE_URL;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied link");
      }
    });

    nativeShareBtn.addEventListener("click", async () => {
      if(navigator.share){
        try{
          await navigator.share({ title: "PuckSweeper", text: "Play PuckSweeper", url: SHARE_URL });
        }catch{}
      }else{
        toast("Native share not supported here");
      }
    });

    // Howto modal events
    howtoBtn.addEventListener("click", () => openModal(howtoModal));
    closeHowtoBtn.addEventListener("click", () => closeModal(howtoModal));
    howtoModal.addEventListener("click", (e) => {
      if(e.target === howtoModal) closeModal(howtoModal);
    });

    // Esc closes whichever modal is open
    window.addEventListener("keydown", (e) => {
      if(e.key !== "Escape") return;
      if(isOpen(shareModal)) closeModal(shareModal);
      if(isOpen(howtoModal)) closeModal(howtoModal);
    });

    // PWA service worker
    if("serviceWorker" in navigator){
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    // Game events
    newBtn.addEventListener("click", newGame);
    difficultyEl.addEventListener("change", newGame);
    flagBtn.addEventListener("click", () => setFlagMode(!flagMode));

    window.addEventListener("resize", () => computeTileSize());
    window.addEventListener("orientationchange", () => setTimeout(computeTileSize, 50));

    newGame();
  })();
  </script>
</body>
</html>
